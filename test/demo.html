<!doctype html>
<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">

  <!-- Use the .htaccess and remove these lines to avoid edge case issues.
       More info: h5bp.com/i/378 -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  <title>pQuery Test</title>
  <meta name="description" content="">

  <style>
    #wrapper {
      margin: 2em auto;
      width: 500px;
    }
    #world {
      background: #333;
    }
  </style>

  <!-- Mobile viewport optimized: h5bp.com/viewport -->
  <meta name="viewport" content="width=device-width">
  <script src="easeljs-0.4.2.min.js"></script>
</head>
<body>
  
  <div id="wrapper">
    <button id="stopstart">Stop</button>
    <div id="info"></div>

    <canvas id="world" width="500" height="500"></canvas>

  </div>

  <!-- JavaScript at the bottom for fast page loading: http://developer.yahoo.com/performance/rules.html#js_bottom -->

  <!-- Grab Google CDN's jQuery, with a protocol relative URL; fall back to local if offline -->
  <!--<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="js/vendor/jquery-1.7.2.min.js"><\/script>')</script>-->

  <script src="../lib/require.js"></script>
  <script>
  	/*require.config({
  		baseUrl: '../src/'
  	});*/
  	require(['../src/pquery'], function(pQuery){
      
      window.jQuery && jQuery.noConflict();


      var stage, bounds;

      //check and see if the canvas element is supported in
      //the current browser
      //http://diveintohtml5.org/detect.html#canvas
      if(!(!!document.createElement('canvas').getContext))
      {
        var wrapper = document.getElementById("wrapper");
        wrapper.innerHTML = "Your browser does not appear to support " +
        "the HTML5 Canvas element";
        return;
      }

      //get a reference to the canvas element
      var canvas = document.getElementById("world");
 
      //copy the canvas bounds to the bounds instance.
      //Note, if we resize the canvas, we need to reset
      //these bounds.
      bounds = new Rectangle();
      bounds.width = canvas.width;
      bounds.height = canvas.height;
      stage = new Stage(canvas);
  

      //center
      var c = new Shape();
        c.x = canvas.width/2;
        c.y = canvas.height/2;
        c.graphics.beginFill(Graphics.getRGB(50,50,255,1));
        c.graphics.drawCircle(0,0,5);
        stage.addChild(c);
      
      // plugin to update position of views
      pQuery.fn.updateView = function(){

        return this.each(function(){

          var self = pQuery(this)
            ,view = self.data('view')
            ,pos
            ;

          if (view){

            pos = self.position();
            view.x = pos.x;
            view.y = pos.y;

          }

        });
      };

      var world = pQuery('world');
      
      function newCircle(x, y, r, vx, vy){

        var c = new Shape();
        c.x = x;
        c.y = y;
        c.graphics.beginFill(Graphics.getRGB(255,200,200,1));
        c.graphics.drawCircle(0,0,r);
        stage.addChild(c);

        return pQuery( '<sphere>' )
          .data( 'view', c )
          .dimensions( r )
          .position( x, y )
          .velocity( vx, vy );
      }

      var spheres = pQuery(null);

      while(spheres.length < 100){
        var x = Math.random() * (500-50) + 25
            ,y = Math.random() * (500-50) + 25
            ,r = Math.random() * 20 + 5
            ;
        var collides = false;
        for(var i = 0, l = spheres.length; i < l; i++){
            var other = spheres[i];
            var pos = pQuery.Vector(x,y);
            pos.vsub(other.position());
            
            if(pos.norm() < other.dimensions().radius + r){
                collides = true;
                break;
            }
        }
        if(!collides){
          spheres = spheres.add(newCircle( 
            x, 
            y, 
            r,
            0*(Math.random()-0.5), 
            0*Math.random()
          ));
        }
      }

      // for(var i = 0, n = 10; i < n; i++){

      //   spheres = spheres.add(newCircle( 
      //     i*25%465+10+5*Math.random(), 
      //     Math.floor((i*30+10)/465)*25+10+5*Math.random(), 
      //     10+Math.floor(Math.random()*15), 
      //     0*(Math.random()-0.5), 
      //     0*Math.random()
      //   ));

      // }

      // spheres = spheres.add(newCircle(400, 120, 10, -.1, 0))
      //   .add(newCircle(100, 120, 10, 0, 0))
        // .add(newCircle(100, 430, 10, 0, 0))
        // .add(newCircle(100, 400, 10, 0, 0));

      spheres.appendTo(world);

      world.on('step', (function(){

        // cache spheres
        var spheres = world.find('sphere');

        return function(){

          spheres.updateView();

          stage.update();
        };
      })());

      // spheres.interact( pQuery.interactions.NewtonianGravity( 1 ) );

      world.interact('soft', 'sphere', function( delta, sph ){

        // earth gravity
        sph.accelerate(0, 0.0005);

      });

      //spheres.interact( pQuery.interactions.Drag( 1/10000 ) );

      var v = pQuery.Vector();

      world
        .dimensions( 500, 500 )
        .interact( pQuery.interactions.SphereCollide( 0.8 ), 'sphere' )
        .interact( pQuery.interactions.ConstrainWithin( world, 0.3 ), 'sphere' )
        ;

      var info = document.getElementById('info');

      pQuery.ticker.subscribe(function(time, dt){

        world.step(time);

      });

      world.on('step', function(){
        //monitor energy
          var E = 0;
          
          spheres.each(function(){
            E += 0.5*v.clone(this.velocity()).normSq();
            var self = this
              , r = this.position()
              ;
            
            E -= 0.001*this.position().y;
            // potential
            // spheres.each(function(){

            //   if ( this === self )return;
            //   E -= 0.5/v.clone(this.position()).vsub(r).norm();

            // });

          })
          
        info.innerHTML = 'FPS: '+world[0].FPS+
          '<br/>steps: '+world[0].nsteps+
          '<br/>Energy: '+ E;

          ;
      })
      
      world.timeStep( 16 );
      pQuery.ticker.start();

      var ss = document.getElementById('stopstart');
      ss.addEventListener('click', function(){

        if ( world.isPaused() ){

          world.unpause();
          ss.innerHTML = 'Start';        
          return;
        }

        ss.innerHTML = 'Stop';
        world.pause();

      });


  	});
  </script>
  <!-- end scripts -->

</body>
</html>